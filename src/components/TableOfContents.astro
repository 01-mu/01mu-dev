---
const {
  headings = [],
  levels = [2, 3],
  title = "On this page",
} = Astro.props;

const visibleHeadings = headings.filter((heading) =>
  levels.includes(heading.depth),
);
---

{visibleHeadings.length > 0 && (
  <div class="toc-root">
    <nav class="toc" aria-label="Table of contents">
      <p class="toc-title">{title}</p>
      <ul class="toc-list">
        {visibleHeadings.map((heading) => (
          <li class={`toc-item depth-${heading.depth}`}>
            <a href={`#${heading.slug}`} data-toc-link={heading.slug}>
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </div>
)}

<script type="module">
  const initToc = () => {
    const root = document.currentScript?.closest(".toc-root");
    if (!root) {
      return;
    }
    const isInline = Boolean(root.closest(".toc-inline"));
    const isMobile = window.matchMedia("(max-width: 720px)").matches;
    if (isInline && isMobile) {
      return;
    }
    const tocContainer = root.querySelector(".toc");
    const links = Array.from(
      root.querySelectorAll("[data-toc-link]"),
    );
    const headings = links
      .map((link) => document.getElementById(link.dataset.tocLink))
      .filter(Boolean);

    if (links.length === 0 || headings.length === 0) {
      return;
    }

    let lastActiveIndex = -1;
    let scrollAnimId = null;
    const smoothScrollTo = (targetTop) => {
      if (scrollAnimId) {
        cancelAnimationFrame(scrollAnimId);
      }
      const startTop = tocContainer.scrollTop;
      const delta = targetTop - startTop;
      const duration = 420;
      const startTime = performance.now();

      const step = (now) => {
        const t = Math.min(1, (now - startTime) / duration);
        const eased = 1 - Math.pow(1 - t, 4);
        tocContainer.scrollTop = startTop + delta * eased;
        if (t < 1) {
          scrollAnimId = requestAnimationFrame(step);
        } else {
          scrollAnimId = null;
        }
      };

      scrollAnimId = requestAnimationFrame(step);
    };
    const pad = 48;
    const setActiveIndex = (activeIndex) => {
      links.forEach((link, index) => {
        link.classList.toggle("is-active", index === activeIndex);
        link.classList.toggle("is-past", index < activeIndex);
      });

      if (activeIndex !== lastActiveIndex) {
        const activeLink = links[activeIndex];
        if (tocContainer && activeLink) {
          const containerRect = tocContainer.getBoundingClientRect();
          const linkRect = activeLink.getBoundingClientRect();
          const topEdge = containerRect.top + pad;
          const bottomEdge = containerRect.bottom - pad;

          if (linkRect.top < topEdge) {
            smoothScrollTo(
              tocContainer.scrollTop - (topEdge - linkRect.top),
            );
          } else if (linkRect.bottom > bottomEdge) {
            smoothScrollTo(
              tocContainer.scrollTop + (linkRect.bottom - bottomEdge),
            );
          }
        }
        lastActiveIndex = activeIndex;
      }
    };

    let offsets = [];
    const updateOffsets = () => {
      offsets = headings.map(
        (heading) => heading.getBoundingClientRect().top + window.scrollY,
      );
    };

    const updateActive = () => {
      const targetY = window.scrollY + window.innerHeight * 0.3;
      let activeIndex = 0;

      offsets.forEach((offset, index) => {
        if (offset <= targetY) {
          activeIndex = index;
        }
      });

      setActiveIndex(activeIndex);
    };

    let ticking = false;
    const onScroll = () => {
      if (ticking) {
        return;
      }
      ticking = true;
      window.requestAnimationFrame(() => {
        updateActive();
        ticking = false;
      });
    };

    window.addEventListener("scroll", onScroll, { passive: true });
    window.addEventListener("resize", () => {
      updateOffsets();
      onScroll();
    });
    updateOffsets();
    updateActive();
  };

  initToc();
</script>

<style>
  .toc {
    max-height: calc(100vh - 16rem);
    overflow-y: auto;
    padding-right: 0.5rem;
  }

  .toc-title {
    font-size: 0.85rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--muted);
    margin: 0 0 0.75rem;
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 0.35rem;
    font-size: 0.9rem;
    color: var(--muted);
  }

  .toc-item a {
    color: inherit;
    position: relative;
    padding: 0.15rem 0.45rem;
    border-radius: 6px;
    transition: color 160ms ease, opacity 160ms ease, background-color 160ms ease;
  }

  .toc-item a.is-active {
    color: var(--ink);
    font-weight: 600;
    background: color-mix(in srgb, var(--ink) 8%, transparent);
  }

  .toc-item a.is-past {
    color: var(--ink);
    opacity: 0.65;
  }

  .toc-item.depth-3 {
    padding-left: 0.9rem;
  }
</style>
